import serial
import time
import threading
import RPi.GPIO as gpio
import re

pwma = 18
ain1 = 22
ain2 = 27
pwmb = 23
bin1 = 25
bin2 = 24

gpio.setwarnings(False)
gpio.setmode(gpio.BCM)
gpio.setup(pwma, gpio.OUT)
gpio.setup(ain1, gpio.OUT)
gpio.setup(ain2, gpio.OUT)
gpio.setup(pwmb, gpio.OUT)
gpio.setup(bin1, gpio.OUT)
gpio.setup(bin2, gpio.OUT)

lmotor = gpio.PWM(pwma, 500)
lmotor.start(0)
rmotor = gpio.PWM(pwmb, 500)
rmotor.start(0)

bleSerial = serial.Serial("/dev/ttyS0", baudrate=9600, timeout=1.0)

gData = ""
current_command = ""

def parse_joystick_data(data):
    try:
        match = re.search(r'J0:(\d+),([\d.]+)', data)
        if match:
            angle = int(match.group(1))
            strength = float(match.group(2))
            return angle, strength
    except:
        pass
    return None, None

def get_direction_from_angle(angle, strength):
    if angle is None or strength is None:
        return None
    
    if strength < 0.3:
        return "stop"
    
    # 위(전진): 45~135도
    if 45 <= angle <= 135:
        return "go"
    # 아래(후진): 225~315도
    elif 225 <= angle <= 315:
        return "back"
    # 왼쪽: 135~225도
    elif 135 < angle < 225:
        return "left"
    # 오른쪽: 315~360도 또는 0~45도
    elif angle > 315 or angle < 45:
        return "right"
    
    return None

def serial_write():
    global gData
    while True:
        try:
            data = bleSerial.readline()
            data = data.decode().strip()
            if data:
                print(f"수신 데이터: [{data}]")
                gData = data
        except Exception as e:
            print(f"Serial error: {e}")

def go():
    print("전진")
    gpio.output(ain1, 0)
    gpio.output(ain2, 1)
    gpio.output(bin1, 0)
    gpio.output(bin2, 1)
    lmotor.ChangeDutyCycle(50)
    rmotor.ChangeDutyCycle(50)

def back():
    print("후진")
    gpio.output(ain1, 1)
    gpio.output(ain2, 0)
    gpio.output(bin1, 1)
    gpio.output(bin2, 0)
    lmotor.ChangeDutyCycle(50)
    rmotor.ChangeDutyCycle(50)

def right():
    print("우회전")
    gpio.output(ain1, 0)
    gpio.output(ain2, 1)
    gpio.output(bin1, 0)
    gpio.output(bin2, 0)
    lmotor.ChangeDutyCycle(50)
    rmotor.ChangeDutyCycle(0)

def left():
    print("좌회전")
    gpio.output(ain1, 0)
    gpio.output(ain2, 0)
    gpio.output(bin1, 0)
    gpio.output(bin2, 1)
    lmotor.ChangeDutyCycle(0)
    rmotor.ChangeDutyCycle(50)

def stop():
    print("정지")
    gpio.output(ain1, 0)
    gpio.output(ain2, 0)
    gpio.output(bin1, 0)
    gpio.output(bin2, 0)
    lmotor.ChangeDutyCycle(0)
    rmotor.ChangeDutyCycle(0)

def main():
    global gData, current_command
    
    try:    
        while True:
            if gData:
                angle, strength = parse_joystick_data(gData)
                direction = get_direction_from_angle(angle, strength)
                
                if direction:
                    print(f"각도: {angle}도, → 방향: {direction}")
                    
                    if direction != current_command:
                        current_command = direction
                        
                        if direction == "go":
                            go()
                        elif direction == "back":
                            back()
                        elif direction == "left":
                            left()
                        elif direction == "right":
                            right()
                        elif direction == "stop":
                            stop()
                
                gData = ""
            
            time.sleep(0.05)
            
    except KeyboardInterrupt:
        stop()
    finally:
        gpio.cleanup()
        bleSerial.close()

if __name__ == "__main__":
    task1 = threading.Thread(target=serial_write, daemon=True)
    task1.start()
    main()
